name: Protect and Deploy

on:
  push:
    branches: [ "main" ]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Node
      uses: actions/setup-node@v4
      with:
        node-version: 18

    # 1. Copy site into dist (excluding system folders)
    - name: Copy site into dist
      run: |
        mkdir dist
        rsync -av \
          --exclude='dist' \
          --exclude='.git' \
          --exclude='.github' \
          --exclude='node_modules' \
          --exclude='package.json' \
          --exclude='package-lock.json' \
          ./ dist/

    # 2. Install tools
    - name: Install tools
      run: |
        npm install javascript-obfuscator html-minifier-terser clean-css-cli

    # 3. Obfuscate JS
    - name: Obfuscate JS
      run: |
        find dist -name "*.js" -type f -exec \
        npx javascript-obfuscator {} --output {} \;

    # 4. Minify HTML
    - name: Minify HTML
      run: |
        find dist -name "*.html" -type f -exec \
        npx html-minifier-terser --collapse-whitespace --remove-comments --minify-css true --minify-js true -o {} {} \;

    # 5. Minify CSS
    - name: Minify CSS
      run: |
        find dist -name "*.css" -type f -exec \
        npx cleancss -o {} {} \;

    # 6. Deploy to gh-pages
    - name: Deploy to gh-pages
      run: |
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"

        git checkout gh-pages

        git rm -rf . > /dev/null 2>&1 || true

        cp -r ../dist/* .

        git add .
        git commit -m "Deploy protected build" || echo "No changes to commit"
        git push origin gh-pages
