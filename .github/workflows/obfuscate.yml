name: Minify + Obfuscate + Deploy

on:
  push:
    branches: [ "main" ]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Node
      uses: actions/setup-node@v4
      with:
        node-version: 18

    # 1. Create dist folder and copy entire site EXCEPT dist/.git/.github/node_modules
    - name: Copy site into dist
      run: |
        mkdir dist
        rsync -av --exclude='dist' --exclude='.git' --exclude='.github' --exclude='node_modules' ./ dist/

    # 2. Install JS obfuscator
    - name: Install obfuscator
      run: npm install javascript-obfuscator

    # 3. Obfuscate JS inside dist (only affects .js files)
    - name: Obfuscate JS
      run: |
        find dist -name "*.js" -type f -exec \
        npx javascript-obfuscator {} --output {} \;

    # 4. Minify HTML
    - name: Minify HTML
      uses: docker://devatherock/minify-js:latest
      with:
        args: "html -r dist"

    # 5. Minify CSS
    - name: Minify CSS
      uses: docker://devatherock/minify-js:latest
      with:
        args: "css -r dist"

    # 6. Deploy dist/ to gh-pages
    - name: Deploy to gh-pages
      run: |
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"

        git checkout gh-pages

        git rm -rf . > /dev/null 2>&1 || true

        cp -r ../dist/* .

        git add .
        git commit -m "Deploy protected build" || echo "No changes to commit"
        git push origin gh-pages
