<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Systematic Theology - Interactive Theological Cosmos</title>
<!-- ═══ RESILIENT ASSET LOADING ═══ -->
<!-- Google Fonts with onerror detection -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link id="google-fonts-link"
 href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400&family=Spectral:ital,wght@0,200;0,300;0,400;0,500;1,300;1,400&family=Cormorant:ital,wght@0,300;0,400;1,300;1,400&display=swap"
 rel="stylesheet"
 onerror="window.__fontsLoaded=false">

<!-- ── Three.js r170 - ES Module Import Map ── -->
<!-- Pinned to 0.170.0 for stability. r170 includes WebGPU groundwork, -->
<!-- improved shader compilation, better memory management, and -->
<!-- significant performance fixes over r128. -->
<script type="importmap">
{
 "imports": {
 "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.min.js"
 }
}
</script>

<script>
// ── Global asset availability flags ──
// null = pending, true = loaded, false = failed
// IMPORTANT: must be null (not false) so boot() waits for the ES module to resolve
window.__threeAvailable = null;
window.__fontsLoaded = null;
</script>

<!-- ── Three.js ES Module Loader with Fallback ── -->
<!-- r150+ removed the UMD build; we import the ES module and expose -->
<!-- window.THREE to keep the rest of the codebase unchanged. -->
<script type="module">
 const CDN_SOURCES = [
 'https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.min.js',
 'https://unpkg.com/three@0.170.0/build/three.module.min.js'
 ];

 async function loadThree() {
 for (const src of CDN_SOURCES) {
 try {
 const THREE = await import(src);
 window.THREE = THREE;
 window.__threeAvailable = true;
 console.log('[CDN] Three.js r170 loaded successfully from: ' + src);
 document.dispatchEvent(new Event('three-load-success'));
 return;
 } catch (err) {
 console.warn('[CDN Fallback] Failed to load Three.js from: ' + src, err);
 }
 }
 console.error('[CDN Fallback] All Three.js CDN sources failed.');
 window.__threeAvailable = false;
 document.dispatchEvent(new Event('three-load-failed'));
 }

 loadThree();
</script>

<script>
(function() {
 // ── Google Fonts detection via Font Loading API with timeout ──
 var FONT_TIMEOUT_MS = 5000;
 if (document.fonts && document.fonts.ready) {
 var fontsTimer = setTimeout(function() {
 if (window.__fontsLoaded === null) {
 window.__fontsLoaded = false;
 console.warn('[Fonts] Google Fonts timed out after ' + FONT_TIMEOUT_MS + 'ms. Using system fallbacks.');
 document.dispatchEvent(new Event('fonts-load-failed'));
 }
 }, FONT_TIMEOUT_MS);

 document.fonts.ready.then(function() {
 return document.fonts.load('400 16px "Cinzel"');
 }).then(function(faces) {
 clearTimeout(fontsTimer);
 if (faces && faces.length > 0) {
 window.__fontsLoaded = true;
 } else if (window.__fontsLoaded === null) {
 window.__fontsLoaded = false;
 document.dispatchEvent(new Event('fonts-load-failed'));
 }
 }).catch(function() {
 clearTimeout(fontsTimer);
 if (window.__fontsLoaded === null) {
 window.__fontsLoaded = false;
 document.dispatchEvent(new Event('fonts-load-failed'));
 }
 });
 }
})();
</script>
<link rel="stylesheet" href="css/cosmos.css">
</head>
<body>

<!-- Degradation Banner (hidden by default, shown on asset failure) -->
<div id="degradation-banner" role="alert" aria-live="polite">
 <span class="banner-icon" aria-hidden="true">⚠</span>
 <span id="banner-message">Some resources failed to load. The application is running in fallback mode.</span>
 <button class="banner-dismiss" onclick="this.parentElement.classList.remove('visible')" aria-label="Dismiss notification">DISMISS</button>
</div>

<!-- Skip Link -->
<a id="skip-link" href="#main-content">Skip to main content</a>

<!-- Loading Screen -->
<div id="loading-screen" role="status" aria-label="Loading application">
 <h1>SYSTEMATIC THEOLOGY</h1>
 <p>INTERACTIVE THEOLOGICAL COSMOS</p>
 <div class="loading-bar" role="progressbar" aria-label="Loading progress" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"><div class="loading-bar-fill" id="loading-fill"></div></div>
 <p id="loading-step" aria-live="polite">Preparing&hellip;</p>
</div>

<!-- Onboarding Screen -->
<div id="onboarding-screen" class="hidden" role="dialog" aria-label="Welcome" aria-modal="true">
 <div class="onboarding-content">
 <h1>SYSTEMATIC THEOLOGY</h1>
 <h2>The First Interactive 3D Theological Cosmos</h2>

 <div class="ob-row" aria-label="Methodology note" style="text-align:center; margin-bottom: 18px;">
 <p style="color: var(--text-secondary); font-family: var(--font-body); font-size: 14.5px; line-height: 1.65; max-width: 540px; margin: 0 auto; font-style: italic; opacity: 0.88;">
 A confessional Reformed exploration of the whole counsel of God&thinsp;&mdash;&thinsp;presented as one faithful perspective on the inexhaustible riches of biblical revelation, not as its exhaustive map. Every doctrine is a window into the living Christ.
 </p>
 </div>

 </div>
 <button class="enter-btn" id="enter-btn">ENTER THE COSMOS</button>
 </div>
</div>

<!-- Main App -->
<div id="app">
 <!-- Top Bar -->
 <header id="topbar" role="banner">
 <div class="brand" aria-hidden="true">
 <div class="brand-title">SYSTEMATIC THEOLOGY</div>
 <div class="brand-rule"></div>
 <div class="brand-cosmos">COSMOS</div>
 </div>
 <div class="search-container" role="search" aria-label="Search doctrines">
 <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
 <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
 </svg>
 <input type="text" id="search-input" placeholder="Search doctrines, scriptures, keywords…" autocomplete="off"
 role="combobox" aria-expanded="false" aria-controls="search-results" aria-activedescendant=""
 aria-autocomplete="list" aria-label="Search doctrines, scriptures, keywords">
 <span class="search-shortcut" aria-hidden="true">⌘K</span>
 <div id="search-results" role="listbox" aria-label="Search results"></div>
 <div id="search-live" class="sr-only" aria-live="polite" aria-atomic="true"></div>
 </div>
 <div class="topbar-controls">
 <div class="progress-badge" id="progress-badge" title="Click to reset progress" role="button" aria-live="polite" aria-label="Entries visited - click to reset">0 / 0</div>
 </div>
 </header>

 <!-- Main Content -->
 <main id="main-content">
 <div id="graph-container">
 <div id="three-container" role="img" aria-label="Interactive 3D theology graph. Use mouse to orbit, scroll to zoom, click nodes to study."></div>
 <div id="graph-vignette" aria-hidden="true"></div>
 <!-- Flythrough Overlay (Improvement #23) -->
 <div id="flythrough-overlay">
 <div class="flythrough-controls">
 <button class="flythrough-btn" id="flythrough-pause">Pause</button>
 <button class="flythrough-btn" id="flythrough-exit">Exit</button>
 </div>
 <div class="flythrough-text" id="flythrough-text">
 <div class="flythrough-locus-name" id="flythrough-locus-name"></div>
 <div class="flythrough-title" id="flythrough-node-title"></div>
 <div class="flythrough-desc" id="flythrough-node-desc"></div>
 <div class="flythrough-progress" id="flythrough-dots"></div>
 </div>
 </div>

 <!-- Flythrough Path Picker -->
 <div id="flythrough-picker-backdrop"></div>
 <div id="flythrough-picker">
 <div class="picker-title">Meditative Flythrough</div>
 <div class="picker-subtitle">Explore every major locus of systematic theology</div>
 <div id="flythrough-picker-list"></div>
 </div>

 <!-- Legend -->
 <div id="legend" role="toolbar" aria-label="Filter by category" aria-orientation="vertical"></div>

 <!-- Breadcrumb -->
 <nav id="breadcrumb" aria-label="Doctrine navigation breadcrumb"></nav>

 <!-- Path Indicator -->
 <div id="path-indicator" role="status" aria-live="polite" aria-label="Study path progress">
 <div class="path-pulse" aria-hidden="true"></div>
 <span id="path-name"></span>
 <button class="path-nav-btn" id="path-prev" aria-label="Previous node in path">‹</button>
 <span id="path-counter" style="font-size:9px;color:var(--text-muted)"></span>
 <button class="path-nav-btn" id="path-next" aria-label="Next node in path">›</button>
 <button class="path-close-btn" id="path-close" aria-label="Close study path">✕</button>
 </div>

 <!-- Tooltip -->
 <div id="tooltip" role="tooltip" aria-hidden="true">
 <div class="tooltip-name" id="tooltip-name"></div>
 <div class="tooltip-category" id="tooltip-category"></div>
 <div class="tooltip-summary" id="tooltip-summary"></div>
 <div class="tooltip-studied" id="tooltip-studied"></div>
 </div>
 </div>

 <!-- Study Panel -->
 <aside id="study-panel" role="dialog" aria-label="Doctrine study panel" aria-modal="false">
 <div class="panel-header">
 <span class="panel-layer-label" id="panel-layer"></span>
 <button class="panel-close-btn" id="panel-close" aria-label="Close study panel">✕</button>
 </div>
 <div class="panel-inner">
 <h2 class="panel-title" id="panel-title" tabindex="-1"></h2>
 <div class="panel-color-bar" id="panel-color-bar" aria-hidden="true"></div>
 <button class="panel-study-toggle" id="panel-study-toggle" aria-pressed="false">
 <span class="check-icon" aria-hidden="true">☐</span> Mark as reviewed
 </button>
 <div class="panel-tabs" role="tablist" aria-label="Panel sections">
 <button class="panel-tab active" role="tab" data-tab="overview" id="tab-btn-overview"
 aria-selected="true" aria-controls="tab-overview" tabindex="0">Overview</button>
 <button class="panel-tab" role="tab" data-tab="connections" id="tab-btn-connections"
 aria-selected="false" aria-controls="tab-connections" tabindex="-1">Connections</button>
 <button class="panel-tab" role="tab" data-tab="study" id="tab-btn-study"
 aria-selected="false" aria-controls="tab-study" tabindex="-1">Study</button>
 </div>
 <div class="tab-pane active" id="tab-overview" role="tabpanel" aria-labelledby="tab-btn-overview">
 <div class="panel-summary" id="panel-summary"></div>
 <div class="panel-desc-wrapper" id="panel-desc-wrapper">
 <div class="panel-description" id="panel-description"></div>
 <div class="panel-desc-fade" id="panel-desc-fade" aria-hidden="true"></div>
 </div>
 <button class="panel-read-more" id="panel-read-more" aria-expanded="false">Read more</button>
 <div id="panel-refs-wrapper">
 <div id="panel-scripture-section" style="display:none;">
 <div class="refs-section-label norma-normans">Scripture</div>
 <div class="panel-scripture-refs" id="panel-scriptures" aria-label="Scripture references (<i>norma normans</i> : the norming norm)"></div>
 </div>
 <div id="panel-confessional-section" style="display:none;">
 <div class="refs-section-label norma-normata">Confessional Standards</div>
 <div class="panel-confessional-refs" id="panel-confessionals" aria-label="Confessional standard references (<i>norma normata</i> : the normed norm)"></div>
 </div>
 </div>
 <div class="panel-keywords" id="panel-keywords" aria-label="Keywords"></div>
 <div class="panel-controversies" id="panel-controversies" aria-label="Historical controversies" style="margin-top:12px;display:none;">
 <div style="font-family:var(--font-ui);font-size:9px;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px;">Historical Controversies</div>
 <div id="panel-controversies-list" style="display:flex;flex-wrap:wrap;gap:4px;"></div>
 </div>
 </div>
 <div class="tab-pane" id="tab-connections" role="tabpanel" aria-labelledby="tab-btn-connections">
 <div class="connections-section" id="subtopics-section">
 <h4>Sub-Topics</h4>
 <div id="subtopics-list" role="list" aria-label="Sub-topics"></div>
 </div>
 <div class="connections-section" id="crossrefs-section">
 <h4>Cross-References</h4>
 <div id="crossrefs-list" role="list" aria-label="Cross-references"></div>
 </div>
 <div class="connections-section" id="related-section" style="display:none">
 <h4>Related Topics <span class="related-badge">auto-discovered</span></h4>
 <div id="related-list" role="list" aria-label="Related topics discovered by keyword and scripture overlap"></div>
 </div>
 </div>
 <div class="tab-pane" id="tab-study" role="tabpanel" aria-labelledby="tab-btn-study">
 <div id="study-cards" aria-label="Study cards"></div>
 </div>
 </div>
 </aside>
 </main>

 <!-- Bottom Bar -->
 <footer id="bottombar" role="contentinfo">
 <div class="bottom-controls" role="toolbar" aria-label="View controls">
 <button class="bottom-btn" id="btn-paths" aria-expanded="false" aria-controls="paths-popup">Study Paths</button>
 <button class="bottom-btn" id="btn-meditate" aria-label="Meditative flythrough of redemptive history">Meditate</button>
 <button class="bottom-btn" id="btn-legend-mobile" aria-expanded="false" aria-label="Filter categories" style="display:none">Categories</button>
 <button class="bottom-btn" id="btn-reset">Reset View</button>
 </div>
 <div class="keyboard-hints" aria-hidden="true">
 <kbd>Esc</kbd> reset · <kbd>⌘K</kbd> search · <kbd>←→</kbd> path nav
 </div>
 </footer>

 <!-- Paths Popup -->
 <div id="paths-popup" role="dialog" aria-label="Guided study paths">
 <div class="paths-title">Guided Study Paths</div>
 <div id="paths-list" role="list" aria-label="Available study paths"></div>
 </div>
</div>

<!-- FTUE Coach Mark Overlay -->
<div id="ftue-overlay" aria-hidden="true"></div>
<div class="ftue-spotlight-ring" id="ftue-ring"></div>
<div class="ftue-card" id="ftue-card" role="dialog" aria-label="Guided tour" aria-modal="false">
 <div class="ftue-card-accent" aria-hidden="true"></div>
 <div class="ftue-card-body">
 <div class="ftue-icon-wrap" id="ftue-icon"></div>
 <div class="ftue-counter" id="ftue-counter"></div>
 <div class="ftue-title" id="ftue-title"></div>
 <div class="ftue-desc" id="ftue-desc"></div>
 </div>
 <div class="ftue-footer">
 <div class="ftue-progress"><div class="ftue-progress-fill" id="ftue-progress-fill"></div></div>
 <div class="ftue-actions">
 <button class="ftue-skip" id="ftue-skip">Skip</button>
 <button class="ftue-next" id="ftue-next">Next</button>
 </div>
 </div>
</div>

<script src="js/ftue.js"></script>
<script src="js/device.js"></script>
<script src="js/data.js"></script>
<script src="js/engine-utils.js"></script>
<script src="js/search.js"></script>
<script src="js/three-engine.js"></script>
<script src="js/ui.js"></script>
<script src="js/init.js"></script>
</body>
</html>
